<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: blob: https://api.allorigins.win;">
    <title>fdrd</title>
    <style>
        html {
            max-width: 80ch;
            margin-inline: auto;
            margin-block: 20px 100px;
            padding-inline: 20px;
            font-family: Inter, Roboto, 'Helvetica Neue', 'Arial Nova', 'Nimbus Sans', Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
        }

        header h1 sup {
            font-size: .5em;
            font-weight: normal;
        }

        #show-button {
            position: absolute;
            top: 0;
            right: 0;
            margin: 1em;
            width: 20px;
            height: 20px;
            border: solid 1px gray;
            border-radius: 100%;
        }

        dialog {
            border: solid 1px gray;

            #close-button {
                border: solid 1px gray;
                border-radius: 100%;
                width: 20px;
                height: 20px;
                float: right;
            }

            p {
                max-width: 50ch;
            }

            form {
                display: grid;
                grid-template-columns: auto 1fr auto;
                gap: .5em;
            }
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            margin-bottom: 10px;

            & .entry-sub {
                opacity: 0.7;
                font-size: 0.8em;
            }
        }

        a {
            color: blue;
        }

        @media (prefers-color-scheme: dark) {
            a {
                color: cornflowerblue
            }
        }

        .spinner {
            margin-inline-start: 10px;
            vertical-align: super;
            border: 2px hidden #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 10px;
            height: 10px;
            animation: spin 2s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“°</text></svg>">

    <script type="module">
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';

        const rssFeedList = document.getElementById('fd');
        const infoDialog = document.getElementById('info-dialog');
        const opmlForm = document.getElementById('opml-form');
        const opmlInput = document.getElementById('opml-url');
        const dialog = document.getElementById("info-dialog");
        const showButton = document.getElementById("show-button");
        const closeButton = document.getElementById("close-button");
        let allPosts = [];

        function timeSince(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / (365 * 24 * 60 * 60);

            if (interval > 1) {
                return Math.floor(interval) + " years ago";
            }
            interval = seconds / (30 * 24 * 60 * 60);
            if (interval > 1) {
                return Math.floor(interval) + " months ago";
            }
            interval = seconds / (24 * 60 * 60);
            if (interval > 1) {
                return Math.floor(interval) + " days ago";
            }
            interval = seconds / (60 * 60);
            if (interval > 1) {
                return Math.floor(interval) + " hours ago";
            }
            interval = seconds / 60;
            if (interval > 1) {
                return Math.floor(interval) + " minutes ago";
            }
            return Math.floor(seconds) + " seconds ago";
        }

        function getDomain(url) {
            return new URL(url).hostname;
        }

        async function fetchWithCORSRetry(url) {
            try {
                return await fetch(url);
            } catch (error) {
                return await fetch(CORS_PROXY + url);
            }
        }

        async function fetchOPML(url) {
            const response = await fetchWithCORSRetry(url);
            if (!response.ok) {
                throw new Error('Failed to fetch OPML file');
            }
            const text = await response.text();
            return new window.DOMParser().parseFromString(text, 'text/xml');
        }

        async function fetchFeed(url) {
            const response = await fetchWithCORSRetry(url);
            if (!response.ok) {
                throw new Error('Failed to fetch RSS feed');
            }
            const text = await response.text();
            return new window.DOMParser().parseFromString(text, 'application/xml');
        }

        function parseOPML(opmlDoc) {
            const outlines = opmlDoc.querySelectorAll('outline[type="rss"]');
            return Array.from(outlines).map(outline => outline.getAttribute('xmlUrl'));
        }

        function parseFeed(feedDoc, sourceUrl) {
            const isAtom = feedDoc.documentElement.nodeName === 'feed';
            if (isAtom) {
                return parseAtom(feedDoc, sourceUrl);
            } else {
                return parseRSS(feedDoc, sourceUrl);
            }
        }

        function parseRSS(rssDoc, sourceUrl) {
            const items = rssDoc.querySelectorAll('item');
            return Array.from(items).map(item => ({
                title: item.querySelector('title').textContent,
                link: item.querySelector('link').textContent,
                pubDate: new Date(item.querySelector('pubDate').textContent),
                source: getDomain(sourceUrl)
            }));
        }

        function parseAtom(atomDoc, sourceUrl) {
            const entries = atomDoc.querySelectorAll('entry');
            return Array.from(entries).map(entry => ({
                title: entry.querySelector('title').textContent,
                link: entry.querySelector('link').getAttribute('href'),
                pubDate: new Date(entry.querySelector('updated').textContent || entry.querySelector('published').textContent),
                source: getDomain(sourceUrl)
            }));
        }

        function sortPostsByDate(posts) {
            return posts.sort((a, b) => b.pubDate - a.pubDate);
        }

        function displayPosts(posts) {
            rssFeedList.innerHTML = '';
            posts.forEach(post => {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = post.link;
                link.textContent = post.title;
                const pubDate = document.createElement('span');
                pubDate.className = 'entry-sub';
                pubDate.innerHTML = `<br>published ${timeSince(post.pubDate)} on ${post.source}`;
                listItem.appendChild(link);
                listItem.appendChild(pubDate);
                rssFeedList.appendChild(listItem);
            });
        }

        function addAndSortPosts(newPosts) {
            allPosts.push(...newPosts);
            allPosts.sort((a, b) => b.pubDate - a.pubDate);
            displayPosts(allPosts);
        }

        async function runFetch() {
            try {
                spinner.style.display = 'inline-block';
                const opmlUrl = localStorage.getItem('opmlUrl');
                if (!opmlUrl) {return };
                const opmlDoc = await fetchOPML(opmlUrl);
                const rssUrls = parseOPML(opmlDoc);

                await Promise.all(rssUrls.map(async url => {
                    try {
                        const rssDoc = await fetchFeed(url);
                        const posts = parseFeed(rssDoc, url);
                        addAndSortPosts(posts);
                    } catch (e) {
                        console.error(`Failed to fetch or parse RSS feed: ${url}`, e);
                    }
                }));
            } catch (e) {
                console.error('Error:', e);
            } finally {
                spinner.style.display = 'none';
            }
        }

        showButton.addEventListener("click", () => {
            opmlInput.value = localStorage.getItem('opmlUrl') || '';
            dialog.showModal();
        });

        closeButton.addEventListener("click", () => {
            dialog.close();
        });

        opmlForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const opmlUrl = opmlInput.value.trim();
            if (opmlUrl) {
                localStorage.setItem('opmlUrl', opmlUrl);
                infoDialog.close();
                allPosts = [];
                rssFeedList.innerHTML = '';
                runFetch();
            }
        });


        runFetch();
    </script>
</head>

<body>
    <header>
        <h1>fdrd <sup>the tiny feed reader</sup><span class="spinner" id="spinner"></span></h1>
        <dialog id="info-dialog">
            <button id="close-button">Ã—</button>
            <p>
                Here you can put a URL pointing to an OPML file, and then all posts from the feeds mentioned in that
                OPML file will get fetched. Note that while all domains that support CORS will be fetched normally, the
                ones that don't will get fetched via a CORS proxy. The proxy that currently is in use is
                https://api.allorigins.win/raw?url=
            </p>
            <form id="opml-form">
                <label for="opml-url">OPML URL:</label>
                <input type="url" id="opml-url" name="opml-url" required>
                <button type="submit">Save</button>
            </form>
        </dialog>
        <button id="show-button">i</button>
    </header>
    <ul id="fd">
    </ul>
</body>
